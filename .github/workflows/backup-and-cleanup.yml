name: Backup & Cleanup

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 20 * * *' # æ¯å¤©æ™šä¸Š 20:00 (UTC) è‡ªåŠ¨è¿è¡Œä¸€æ¬¡ï¼Œå¯è‡ªè¡Œä¿®æ”¹

permissions:
  contents: write  # å…è®¸åˆ›å»º Release
  actions: write   # å…è®¸åˆ é™¤æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•

jobs:
  backup-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æŸ¥ä»£ç ä»“åº“
        uses: actions/checkout@v4

      - name: è·å–å½“å‰æ—¶é—´æˆ³
        id: date
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M')" >> $GITHUB_ENV

      - name: æ‰“åŒ…é…ç½®æ–‡ä»¶ (æ’é™¤å·¥ä½œæµç›®å½•)
        run: |
          # å®‰è£… zip (é€šå¸¸ ubuntu-latest è‡ªå¸¦ï¼Œé˜²æ­¢ä¸‡ä¸€)
          sudo apt-get install -y zip
          
          # æ‰“åŒ…å½“å‰ç›®å½•ä¸‹æ‰€æœ‰å†…å®¹
          # -r: é€’å½’
          # -x: æ’é™¤ .git æ–‡ä»¶å¤¹å’Œ .github æ–‡ä»¶å¤¹ (å³å·¥ä½œæµç›®å½•)
          zip -r "Config_Backup_${{ env.TIMESTAMP }}.zip" . -x ".git/*" ".github/*" "README.md"

          echo "æ‰“åŒ…å®Œæˆï¼š"
          ls -lh "Config_Backup_${{ env.TIMESTAMP }}.zip"

      - name: åˆ›å»º Release å¹¶ä¸Šä¼ å¤‡ä»½
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "backup-${{ env.TIMESTAMP }}"
          name: "ğŸ“… è‡ªåŠ¨å¤‡ä»½: ${{ env.TIMESTAMP }}"
          body: |
            ## ğŸ—ƒï¸ é…ç½®æ–‡ä»¶å®šæœŸå¤‡ä»½
            
            > è‡ªåŠ¨ç”Ÿæˆçš„å¤‡ä»½æ–‡ä»¶ï¼ŒåŒ…å«æˆªè‡³ç›®å‰çš„æ‰€æœ‰é…ç½®æ–‡ä»¶ã€‚
            
            - **æ—¶é—´**: ${{ env.TIMESTAMP }}
            - **å†…å®¹**: æ’é™¤å·¥ä½œæµæ–‡ä»¶çš„çº¯å‡€é…ç½®åŒ…
          files: |
            Config_Backup_${{ env.TIMESTAMP }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup-workflows:
    runs-on: ubuntu-latest
    needs: backup-and-release # å¤‡ä»½æˆåŠŸåå†æ¸…ç†
    steps:
      - name: æ¸…ç†æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 3    # ä¿ç•™æœ€è¿‘ 3 å¤©çš„è®°å½•
          keep_minimum_runs: 3 # æ¯ä¸ªå·¥ä½œæµè‡³å°‘ä¿ç•™ 3 ä¸ªæœ€æ–°çš„è®°å½•
          # delete_workflow_pattern: "Update File Test" # (å¯é€‰) æŒ‡å®šåªæ¸…ç†ç‰¹å®šçš„å·¥ä½œæµï¼Œä¸å†™åˆ™æ¸…ç†æ‰€æœ‰
