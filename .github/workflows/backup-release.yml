name: Backup & Release

on:
  workflow_run:
    workflows: ["Generate Documentation"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  release:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Tree Tool
        run: sudo apt-get install -y tree

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Prepare Timestamp
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M')" >> $GITHUB_ENV

      - name: Generate Manifest and Archive
        run: |
          # ç”Ÿæˆè¯¦ç»†æ¸…å•ï¼ˆå«ç›®å½•æ ‘ï¼‰
          python3 << 'PYTHON_SCRIPT'
          import os
          import subprocess

          timestamp = "${{ env.TIMESTAMP }}"
          
          # ä¿®æ”¹ï¼šåªå…³æ³¨è¿™ä¸‰ä¸ªç›®å½•
          TARGET_DIRS = {
              "THEYAMLS": "ğŸ“ YAML é…ç½®ç›®å½• (THEYAMLS)",
              "Overwrite/THEINI": "ğŸ“ INI è¦†å†™é…ç½® (THEINI)",
              "Overwrite/THEOPENCLASH": "ğŸ“ OpenClash è¦†å†™é…ç½® (THEOPENCLASH)"
          }

          lines = []
          lines.append(f"## ğŸ“¦ Auto Backup")
          lines.append(f"> ğŸ•’ **Time:** {timestamp}")
          lines.append(f"> ğŸ’¾ **This release contains configs from:** THEYAMLS, THEINI, THEOPENCLASH\n")

          def get_size_str(path):
              try:
                  size = os.path.getsize(path)
                  if size < 1024: return f"{size} B"
                  return f"{size/1024:.1f} KB"
              except: return "N/A"

          # 1. ç”Ÿæˆæ–‡ä»¶æ¸…å•è¡¨æ ¼
          for folder, title in TARGET_DIRS.items():
              if not os.path.exists(folder): 
                  lines.append(f"### {title}")
                  lines.append("_Directory not found_\n")
                  continue
              
              lines.append(f"### {title}")
              lines.append("| Path | Size |")
              lines.append("| :--- | :--- |")
              
              has_files = False
              for root, dirs, files in os.walk(folder):
                  # æ’é™¤ .git ç­‰éšè—ç›®å½•
                  dirs[:] = [d for d in dirs if not d.startswith('.')]
                  for file in sorted(files):
                      if file == "README.md" or file.startswith("."): continue
                      full_path = os.path.join(root, file)
                      rel_path = os.path.relpath(full_path, folder)
                      size = get_size_str(full_path)
                      lines.append(f"| `{rel_path}` | {size} |")
                      has_files = True
              
              if not has_files:
                  lines.append("| _No config files_ | - |")
              
              lines.append("")  # ç©ºè¡Œåˆ†éš”

          # 2. æ·»åŠ  Linux æ ‡å‡†æ ‘å½¢ç›®å½•ç»“æ„
          lines.append("## ğŸ“‚ Directory Tree Structure")
          lines.append("")
          lines.append("```text")
          
          # ä½¿ç”¨ç³»ç»Ÿ tree å‘½ä»¤ç”Ÿæˆæ ‡å‡† Linux ç›®å½•æ ‘
          tree_output = subprocess.run(
              ["tree", "THEYAMLS", "Overwrite/THEINI", "Overwrite/THEOPENCLASH", 
               "-L", "4", "--charset", "utf-8", "--dirsfirst"],
              capture_output=True, text=True
          )
          
          if tree_output.returncode == 0:
              lines.append(tree_output.stdout.strip())
          else:
              # å¦‚æœ tree å¤±è´¥ï¼Œä½¿ç”¨ Python ç®€æ˜“ç‰ˆæœ¬
              for folder in TARGET_DIRS.keys():
                  if os.path.exists(folder):
                      lines.append(f"{folder}/")
                      for root, dirs, files in os.walk(folder):
                          level = root.replace(folder, '').count(os.sep)
                          indent = ' ' * 2 * (level) + 'â”œâ”€â”€ '
                          subindent = ' ' * 2 * (level + 1) + 'â”œâ”€â”€ '
                          if level > 0:
                              lines.append(f"{indent}{os.path.basename(root)}/")
                          for file in sorted(files)[:10]:  # é™åˆ¶æ˜¾ç¤ºé¿å…è¿‡é•¿
                              lines.append(f"{subindent}{file}")
                          if len(files) > 10:
                              lines.append(f"{subindent}... and {len(files)-10} more files")
          
          lines.append("```")
          lines.append("")

          with open("release_body.md", "w", encoding="utf-8") as f:
              f.write("\n".join(lines))
          
          print("Generated release_body.md with tree structure")
          PYTHON_SCRIPT

          # æ‰“åŒ…æŒ‡å®šä¸‰ä¸ªç›®å½•ï¼ˆä»…åŒ…å«é…ç½®æ–‡ä»¶ï¼Œæ’é™¤ READMEï¼‰
          sudo apt-get install -y zip -qq
          zip -r "Config_Backup_${{ env.TIMESTAMP }}.zip" \
            THEYAMLS \
            Overwrite/THEINI \
            Overwrite/THEOPENCLASH \
            -x "*/README.md" \
            -x "*/.git*" \
            -x "*/.github*"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "backup-${{ env.TIMESTAMP }}"
          name: "ğŸ“… Auto Backup: ${{ env.TIMESTAMP }}"
          body_path: release_body.md
          files: Config_Backup_${{ env.TIMESTAMP }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup:
    runs-on: ubuntu-latest
    needs: release
    if: always()
    steps:
      # æ¸…ç† Update Configs (åªä¿ç•™æœ€è¿‘1æ¬¡)
      - name: Cleanup Update Configs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 1
          delete_workflow_pattern: "Update Configs"
          
      # æ¸…ç† Generate Documentation (åªä¿ç•™æœ€è¿‘1æ¬¡)
      - name: Cleanup Generate Documentation
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 1
          delete_workflow_pattern: "Generate Documentation"
          
      # æ¸…ç† Backup & Release (åªä¿ç•™æœ€è¿‘1æ¬¡)
      - name: Cleanup Backup & Release
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 1
          delete_workflow_pattern: "Backup & Release"
